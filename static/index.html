<!doctype html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Khazieh Emin</title>
  <style>
    body{
      font-family: system-ui, Arial;
      max-width: 1100px;
      margin: 24px auto;
      padding: 0 12px;
      background:
        linear-gradient(rgba(255,255,255,0.92), rgba(255,255,255,0.92)),
        url("./bilder/IMG_5188.JPG") no-repeat center center fixed;
      background-size: cover;
    }

    h1 { margin-bottom: 12px; }
    .row{display:flex; gap:8px; flex-wrap:wrap; align-items:center;}
    input,button{padding:10px 12px; font-size:14px;}
    button{cursor:pointer; border:1px solid #ccc; background:#fff; border-radius:4px;}
    button:hover{background:#f5f5f5;}
    
    /* Mobilanpassad tabell */
    table{width:100%; border-collapse:collapse; margin-top:12px; background:rgba(255,255,255,0.75);}
    th,td{border-bottom:1px solid #ddd; padding:10px; text-align:left; vertical-align:top;}
    
    .error{background:#ffe5e5; border:1px solid #ffb3b3; padding:10px; margin-top:10px; display:none;}
    .danger{background:#c62828; color:white; border:0;}
    .note{font-size:12px; opacity:0.8; margin-top:8px;}
    .card{background:rgba(255,255,255,0.85); border:1px solid rgba(0,0,0,0.08); border-radius:10px; padding:14px; margin-top:12px;}
    .hidden{display:none !important;}
    .kvar{font-weight:700;}
    .positive{color:#2e7d32; font-weight:700;}
    .negative{color:#c62828; font-weight:700;}
    
    /* Historik */
    .history-row{display:none; background:#f9f9f9;}
    .history-row.show{display:table-row;}
    .history-content{padding:12px; font-size:13px;}
    .history-item{padding:6px 0; border-bottom:1px solid #eee;}
    .history-item:last-child{border:0;}
    .history-date{color:#666; font-size:11px;}
    .history-toggle{cursor:pointer; color:#1976d2; text-decoration:underline;}
    
    /* Mobilanpassning */
    @media (max-width: 768px) {
      body{margin:12px 8px; padding:0 8px;}
      h1{font-size:24px;}
      input,button{padding:12px; font-size:16px; touch-action:manipulation;}
      
      /* G√∂m mindre viktiga kolumner p√• mobil */
      .hide-mobile{display:none;}
      
      /* St√∂rre knappar p√• mobil */
      button{min-height:44px; min-width:44px;}
      
      /* Stack knappar vertikalt p√• sm√• sk√§rmar */
      .action-buttons{flex-direction:column; width:100%;}
      .action-buttons button{width:100%; margin:2px 0;}
    }
  </style>
</head>
<body>
  <h1>Khazieh Emin</h1>

  <!-- LOGIN -->
  <div id="loginCard" class="card">
    <div class="row">
      <input id="passwordInput" type="password" placeholder="L√∂senord" />
      <button id="loginBtn" type="button">Logga in</button>
      <button id="logoutBtn" type="button" class="danger">Logga ut</button>
    </div>
   <!-- <div class="note">L√∂senordet finns i Azure som env <code>APP_PASSWORD</code>.</div>
  </div> -->

  <div id="error" class="error"></div>

  <!-- APP -->
  <form id="addForm" class="row hidden" autocomplete="off">
    <input id="nameInput" placeholder="Namn (minst 2 tecken)" />
    <button type="submit">L√§gg till</button>
    <!-- <button type="button" class="danger" id="resetAllBtn">Nollst√§ll alla</button> -->
  </form>

  <table id="table" class="hidden">
    <thead>
      <tr>
        <th>Namn</th>
        <th class="hide-mobile">Liter (kvar)</th>
        <th class="hide-mobile">Summa (kvar)</th>
        <th class="hide-mobile">Betalt (totalt)</th>
        <th>Kvar</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

<script>
const API = "/api";

const elError = document.getElementById("error");
const tbody = document.getElementById("tbody");

const addForm = document.getElementById("addForm");
const nameInput = document.getElementById("nameInput");
const resetAllBtn = document.getElementById("resetAllBtn");

const passwordInput = document.getElementById("passwordInput");
const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");

const table = document.getElementById("table");

let APP_PASSWORD = localStorage.getItem("APP_PASSWORD") || "";

function showError(msg){
  elError.textContent = msg || "";
  elError.style.display = msg ? "block" : "none";
}

function setLoggedIn(isLoggedIn){
  addForm.classList.toggle("hidden", !isLoggedIn);
  table.classList.toggle("hidden", !isLoggedIn);
  logoutBtn.disabled = !isLoggedIn;
}

function fmt(n){ return Number(n).toFixed(2); }
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
  }[m]));
}

async function req(path, opts = {}){
  const headers = {
    "Content-Type": "application/json",
    ...(opts.headers || {})
  };
  if (APP_PASSWORD) headers["X-App-Password"] = APP_PASSWORD;

  const res = await fetch(path, { method:"GET", ...opts, headers });

  if (!res.ok){
    const text = await res.text().catch(()=> "");
    let msg = `HTTP ${res.status}`;
    try{
      const data = text ? JSON.parse(text) : null;
      msg = (data && (data.detail || data.message)) ? (data.detail || data.message) : (text || msg);
    }catch{
      msg = text || msg;
    }
    throw new Error(msg);
  }

  if (res.status === 204) return null;
  const ct = res.headers.get("content-type") || "";
  if (ct.includes("application/json")) return res.json();
  return res.text();
}

async function doLogin(password){
  showError("");
  await req(`${API}/login`, { method:"POST", body: JSON.stringify({ password }) });
  APP_PASSWORD = password;
  localStorage.setItem("APP_PASSWORD", APP_PASSWORD);
  setLoggedIn(true);
  await load();
}

function doLogout(){
  APP_PASSWORD = "";
  localStorage.removeItem("APP_PASSWORD");
  tbody.innerHTML = "";
  setLoggedIn(false);
  showError("Utloggad.");
}

async function load(){
  showError("");
  const friends = await req(`${API}/friends`);
  tbody.innerHTML = "";

  for (const f of friends){
    const tr = document.createElement("tr");
    
    // Best√§m CSS-klass baserat p√• saldo
    let kvarClass = "kvar";
    if (f.remainingSek < 0) {
      kvarClass += " positive"; // √ñverskott (negativ skuld) = gr√∂nt
    } else if (f.remainingSek > 0) {
      kvarClass += " negative"; // Skuld = r√∂tt
    }
    
    // Visa √∂verskott med plustecken
    const kvarText = f.remainingSek < 0 
      ? `+${fmt(Math.abs(f.remainingSek))}` 
      : fmt(f.remainingSek);
    
    tr.innerHTML = `
      <td>
        ${escapeHtml(f.name)}<br>
        <span class="history-toggle" data-id="${f.id}">üìã Visa historik</span>
      </td>
      <td class="hide-mobile">${fmt(f.totalLiters)}</td>
      <td class="hide-mobile">${fmt(f.totalSek)}</td>
      <td class="hide-mobile">${fmt(f.paidSek)}</td>
      <td class="${kvarClass}">${kvarText}</td>
      <td>
        <div class="row action-buttons">
          <button type="button" data-act="add" data-id="${f.id}">+ liter</button>
          <button type="button" data-act="pay" data-id="${f.id}">betalt</button>
          <button type="button" data-act="rename" data-id="${f.id}">byt namn</button>
          <button type="button" data-act="reset" data-id="${f.id}">nollst√§ll</button>
          <button type="button" class="danger" data-act="del" data-id="${f.id}">ta bort</button>
        </div>
      </td>
    `;
    tbody.appendChild(tr);
    
    // L√§gg till historik-rad (dold initialt)
    const historyTr = document.createElement("tr");
    historyTr.className = "history-row";
    historyTr.dataset.id = f.id;
    historyTr.innerHTML = `
      <td colspan="6">
        <div class="history-content" data-id="${f.id}">
          <em>Laddar historik...</em>
        </div>
      </td>
    `;
    tbody.appendChild(historyTr);
  }
}

async function loadHistory(friendId){
  const historyContent = document.querySelector(`.history-content[data-id="${friendId}"]`);
  try{
    const transactions = await req(`${API}/friends/${friendId}/transactions`);
    
    if (transactions.length === 0){
      historyContent.innerHTML = "<em>Ingen historik √§nnu.</em>";
      return;
    }
    
    let html = "";
    for (const t of transactions){
      const date = new Date(t.createdAt).toLocaleString("sv-SE", {
        year: 'numeric', month: 'short', day: 'numeric',
        hour: '2-digit', minute: '2-digit'
      });
      
      let icon = "üìù";
      if (t.type === "add_liters") icon = "‚õΩ";
      if (t.type === "payment") icon = "üí∞";
      if (t.type === "reset") icon = "üîÑ";
      if (t.type === "created") icon = "‚ú®";
      
      html += `
        <div class="history-item">
          ${icon} ${escapeHtml(t.description)}
          <div class="history-date">${date}</div>
        </div>
      `;
    }
    
    historyContent.innerHTML = html;
  }catch(err){
    historyContent.innerHTML = `<em>Kunde inte ladda historik: ${err.message}</em>`;
  }
}

loginBtn.addEventListener("click", async () => {
  try{
    const pw = (passwordInput.value || "").trim();
    if (!pw) return showError("Skriv l√∂senord.");
    await doLogin(pw);
    passwordInput.value = "";
  }catch(e){
    showError(e.message || "Fel l√∂senord.");
    setLoggedIn(false);
  }
});

passwordInput.addEventListener("keydown", (e) => {
  if (e.key === "Enter"){
    e.preventDefault();
    loginBtn.click();
  }
});

logoutBtn.addEventListener("click", () => doLogout());

addForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  try{
    const name = nameInput.value.trim();
    if (name.length < 2) return showError("Namn m√•ste vara minst 2 tecken.");

    await req(`${API}/friends`, { method:"POST", body: JSON.stringify({ name }) });
    nameInput.value = "";
    await load();
  }catch(err){
    showError(err.message);
    if (String(err.message || "").includes("401")) doLogout();
  }
});

if (resetAllBtn) {
  resetAllBtn.addEventListener("click", async () => {
    if (!confirm("Nollst√§ll ALLA?")) return;
    try{
      await req(`${API}/reset-all`, { method:"POST" });
      await load();
    }catch(err){
      showError(err.message);
      if (String(err.message || "").includes("401")) doLogout();
    }
  });
}

tbody.addEventListener("click", async (e) => {
  // Hantera historik-toggle
  if (e.target.classList.contains("history-toggle")){
    const friendId = e.target.dataset.id;
    const historyRow = document.querySelector(`.history-row[data-id="${friendId}"]`);
    
    if (historyRow.classList.contains("show")){
      historyRow.classList.remove("show");
      e.target.textContent = "üìã Visa historik";
    } else {
      historyRow.classList.add("show");
      e.target.textContent = "üìã D√∂lj historik";
      await loadHistory(friendId);
    }
    return;
  }
  
  const btn = e.target.closest("button");
  if (!btn) return;

  const id = btn.dataset.id;
  const act = btn.dataset.act;

  try{
    showError("");

    if (act === "add"){
      const litersStr = prompt("Liter att l√§gga till:", "1");
      if (litersStr === null) return;
      const liters = Number(litersStr);
      if (!Number.isFinite(liters) || liters <= 0) return showError("Liter m√•ste vara ett tal > 0.");

      await req(`${API}/friends/${id}/add-liters`, { method:"POST", body: JSON.stringify({ liters }) });
    }

    if (act === "pay"){
      const amountStr = prompt("Hur mycket har personen betalat (kr)?", "100");
      if (amountStr === null) return;
      const amount = Number(amountStr);
      if (!Number.isFinite(amount) || amount <= 0) return showError("Belopp m√•ste vara ett tal > 0.");

      // ‚úÖ backend till√•ter nu √∂verbetalning - skapar √∂verskott
      await req(`${API}/friends/${id}/pay`, { method:"POST", body: JSON.stringify({ amount }) });
    }

    if (act === "rename"){
      const name = prompt("Nytt namn:");
      if (name === null) return;
      const cleaned = name.trim();
      if (cleaned.length < 2) return showError("Namn m√•ste vara minst 2 tecken.");

      await req(`${API}/friends/${id}`, { method:"PUT", body: JSON.stringify({ name: cleaned }) });
    }

    if (act === "reset"){
      if (!confirm("Nollst√§ll v√§n?")) return;
      await req(`${API}/friends/${id}/reset`, { method:"POST" });
    }

    if (act === "del"){
      if (!confirm("Ta bort v√§n?")) return;
      await req(`${API}/friends/${id}`, { method:"DELETE" });
    }

    await load();
  }catch(err){
    showError(err.message);
    if (String(err.message || "").includes("401")) doLogout();
  }
});

// Auto-boot
(async function boot(){
  try{
    if (APP_PASSWORD){
      setLoggedIn(true);
      await load();
    }else{
      setLoggedIn(false);
    }
  }catch{
    doLogout();
  }
})();
</script>
</body>
</html>
